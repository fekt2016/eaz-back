name: 🚀 SSH Deployment for Express Backend

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: 🎉 Deploy Backend to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://eazworld.com

    steps:
      - name: 🚚 Checkout code
        uses: actions/checkout@v4

      - name: 🔒 Verify SSH secrets
        run: |
          echo "Verifying SSH secrets..."
          if [ -z "${{ secrets.SSH_KEY }}" ]; then
            echo "::error::SSH_KEY secret is missing!"
            exit 1
          fi
          echo "✅ SSH_KEY secret verified successfully"

      - name: 📦 Install dependencies
        run: |
          npm ci --only=production

      - name: 📤 Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: eazworld.com # Directly hardcoded host
          username: eazworld # Directly hardcoded username
          key: ${{ secrets.SSH_KEY }}
          port: 22 # Directly hardcoded port
          script: |
            echo "🚀 Starting deployment process..."
            cd /home2/eazworld/public_html/myapp

            # Pull the latest code
            git pull origin main

            # Install production dependencies
            npm install --production

            # Restart the application with PM2
            if pm2 list | grep -q "myapp"; then
              echo "🔄 Restarting existing PM2 process..."
              pm2 restart myapp
            else
              echo "⭐ Starting new PM2 process..."
              pm2 start server.js --name myapp
            fi

            # Save PM2 process list
            pm2 save

            echo "✅ Deployment completed successfully!"

      - name: 📋 Verify deployment
        run: |
          echo "Backend deployment completed!"
          echo "API endpoint: https://eazworld.com"
          echo "PM2 status should be online"
