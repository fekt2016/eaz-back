name: 🚀 SSH Deployment for Express Backend

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: 🎉 Deploy Backend to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://eazworld.com

    steps:
      - name: 🚚 Checkout code
        uses: actions/checkout@v4

      - name: 🔍 Debug SSH Key
        run: |
          echo "Checking SSH_KEY secret..."
          if [ -n "${{ secrets.SSH_KEY }}" ]; then
            echo "✅ SSH_KEY exists and has content"
            echo "Key starts with: $(echo "${{ secrets.SSH_KEY }}" | head -c 50)"
            echo "Key length: $(echo -n "${{ secrets.SSH_KEY }}" | wc -c) characters"
          else
            echo "❌ SSH_KEY is empty or missing"
            exit 1
          fi

      - name: 📦 Install dependencies
        run: |
          npm ci --only=production --legacy-peer-deps

      - name: 📤 Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: eazworld.com
          username: eazworld
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "🚀 Starting deployment process..."
            cd /home2/eazworld/public_html/myapp

            # Pull the latest code
            git pull origin main

            # Install production dependencies
            npm install --production --legacy-peer-deps

            # Restart the application with PM2
            if pm2 list | grep -q "myapp"; then
              echo "🔄 Restarting existing PM2 process..."
              pm2 restart myapp
            else
              echo "⭐ Starting new PM2 process..."
              pm2 start server.js --name myapp
            fi

            # Save PM2 process list
            pm2 save

            echo "✅ Deployment completed successfully!"

      - name: 📋 Verify deployment
        run: |
          echo "Backend deployment completed!"
          echo "API endpoint: https://eazworld.com"
          echo "PM2 status should be online"
