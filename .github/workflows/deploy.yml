name: ğŸš€ SSH Deployment for Express Backend

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: ğŸ‰ Deploy Backend to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://eazworld.com

    steps:
      - name: ğŸšš Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Verify SSH secrets
        run: |
          echo "Verifying that SSH_KEY secret is configured..."
          # This just confirms the secret exists in workflow configuration
          echo "âœ… Proceeding to deployment..."

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci --only=production

      - name: ğŸ“¤ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: eazworld.com
          username: eazworld
          key: ${{ secrets.SSH_KEY }} # This is where the secret is actually used
          port: 22
          script: |
            echo "ğŸš€ Starting deployment process..."
            cd /home2/eazworld/public_html/myapp

            # Pull the latest code
            git pull origin main

            # Install production dependencies
            npm install --production

            # Restart the application with PM2
            if pm2 list | grep -q "myapp"; then
              echo "ğŸ”„ Restarting existing PM2 process..."
              pm2 restart myapp
            else
              echo "â­ Starting new PM2 process..."
              pm2 start server.js --name myapp
            fi

            # Save PM2 process list
            pm2 save

            echo "âœ… Deployment completed successfully!"

      - name: ğŸ“‹ Verify deployment
        run: |
          echo "Backend deployment completed!"
          echo "API endpoint: https://eazworld.com"
          echo "PM2 status should be online"
