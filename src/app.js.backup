/**
 * =========================================================
 * ENV SETUP (MUST BE FIRST)
 * =========================================================
 */
const dotenv = require('dotenv');
const path = require('path');
const fs = require('fs');

const envPath = path.join(__dirname, '../.env');
const configEnvPath = path.join(__dirname, '../config.env');

if (fs.existsSync(envPath)) dotenv.config({ path: envPath });
else if (fs.existsSync(configEnvPath)) dotenv.config({ path: configEnvPath });
else dotenv.config();

const isDevelopment = process.env.NODE_ENV !== 'production';
const isProduction = !isDevelopment;

/**
 * =========================================================
 * CORE DEPENDENCIES
 * =========================================================
 */
const express = require('express');
const cors = require('cors');
const cookieParser = require('cookie-parser');
const morgan = require('morgan');
const helmet = require('helmet');
const compression = require('compression');
const rateLimit = require('express-rate-limit');
const slowDown = require('express-slow-down');
const mongoSanitize = require('express-mongo-sanitize');
const xss = require('xss-clean');
const hpp = require('hpp');

const configureCloudinary = require('./config/cloudinary');
const AppError = require('./utils/errors/appError');
const globalErrorHandler = require('./controllers/shared/errorController');

const { attachNonce, getNonceDirective } = require('./middleware/security/cspNonce');
const { enforceHttps } = require('./middleware/security/httpsEnforcement');
const { csrfProtection, getCsrfToken } = require('./middleware/csrf/csrfProtection');

const app = express();

/**
 * =========================================================
 * CLOUDINARY
 * =========================================================
 */
app.set('cloudinary', configureCloudinary());

/**
 * =========================================================
 * CSP NONCE (REQUIRED FOR CSP)
 * =========================================================
 */
app.use(attachNonce);

/**
 * =========================================================
 * SECURITY CONFIGURATIONS
 * =========================================================
 * Separated by environment for clarity:
 * - CSP: Content Security Policy
 * - HSTS: HTTP Strict Transport Security
 * - CORS: Cross-Origin Resource Sharing
 * - CSRF: Cross-Site Request Forgery (configured in middleware)
 */

// =========================================================
// CSP CONFIGURATION (Development vs Production)
// =========================================================
const getCSPConfig = (nonceDirective) => {
  const baseDirectives = {
    defaultSrc: ["'self'"],
    
    scriptSrc: [
      "'self'",
      nonceDirective,
      "'unsafe-inline'", // Required for Paystack and some third-party scripts
      'https://checkout.paystack.com',
    ],
    
    styleSrc: [
      "'self'",
      nonceDirective,
      "'unsafe-inline'", // Required for some third-party styles
      'https://fonts.googleapis.com',
    ],
    
    fontSrc: ["'self'", 'https://fonts.gstatic.com'],
    imgSrc: ["'self'", 'data:', 'https://res.cloudinary.com'],
    
    frameSrc: ["'self'", 'https://checkout.paystack.com'],
    baseUri: ["'self'"],
    formAction: ["'self'", 'https://checkout.paystack.com'],
  };

  // Development-specific CSP directives
  if (isDevelopment) {
    return {
      ...baseDirectives,
      scriptSrc: [...baseDirectives.scriptSrc, 'blob:'], // Vite Web Workers
      connectSrc: [
        "'self'",
        'http://localhost:*',      // Allow all localhost ports
        'http://127.0.0.1:*',      // Allow all IPv4 localhost ports
        'ws:',                     // WebSocket support
        'https://api.cloudinary.com',
        'https://api.paystack.co',
        'https://checkout.paystack.com',
      ],
      workerSrc: ["'self'", 'blob:'], // Vite Web Workers
      upgradeInsecureRequests: null,   // Disabled in development (allows HTTP)
    };
  }

  // Production CSP directives (strict)
  return {
    ...baseDirectives,
    connectSrc: [
      "'self'",
      'https://api.cloudinary.com',
      'https://api.paystack.co',
      'https://checkout.paystack.com',
    ],
    workerSrc: ["'self'"], // Workers served from same origin in production
    upgradeInsecureRequests: [], // Force HTTPS upgrade in production
  };
};

// =========================================================
// HSTS CONFIGURATION (Development vs Production)
// =========================================================
const getHSTSConfig = () => {
  // Development: Disable HSTS to allow HTTP localhost
  if (isDevelopment) {
    return false;
  }

  // Production: Enable HSTS with maximum security
  return {
    maxAge: 31536000,        // 1 year
    includeSubDomains: true, // Apply to all subdomains
    preload: true,           // Allow HSTS preload
  };
};

// =========================================================
// CORS CONFIGURATION (Development vs Production)
// =========================================================
const getCORSConfig = () => {
  // Development origins (multiple localhost ports for different apps)
  const devOrigins = [
    'http://localhost:5173', // saiisaiweb
    'http://localhost:5174', // eazadmin
    'http://localhost:5175', // eazseller
    'http://127.0.0.1:5173', // IPv4 support
  ];

  // Production origins from environment variables
  const productionOrigins = process.env.FRONTEND_URL
    ? process.env.FRONTEND_URL.split(',').map(url => url.trim())
    : [];

  return {
    origin: (origin, callback) => {
      // Allow requests with no origin (mobile apps, Postman, curl, etc.)
      if (!origin) {
        return callback(null, true);
      }

      // Development: Allow specific localhost origins
      if (isDevelopment && devOrigins.includes(origin)) {
        return callback(null, true);
      }

      // Production: Allow only configured frontend URLs
      if (isProduction && productionOrigins.includes(origin)) {
        return callback(null, true);
      }

      // Block all other origins
      console.warn(`[CORS] Blocked origin: ${origin} (env: ${process.env.NODE_ENV || 'development'})`);
      return callback(new Error(`CORS blocked: ${origin}`), false);
    },
    credentials: true, // Required for cookie-based authentication
    methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'OPTIONS'],
    allowedHeaders: [
      'Content-Type',
      'Authorization',
      'X-CSRF-Token',
      'X-User-Role',
      'x-seller-subdomain',
      'x-admin-subdomain',
      'x-client-app',
      'x-client-screen',
      'x-client-screen-params',
      'x-device-id',
      'x-platform',
      'x-mobile',
    ],
    exposedHeaders: ['Content-Range', 'X-Total-Count'],
    optionsSuccessStatus: 200, // Legacy browser compatibility
    maxAge: 86400,              // 24 hours preflight cache (Chrome optimization)
    preflightContinue: false,   // Handle preflight immediately
  };
};

/**
 * =========================================================
 * HELMET MIDDLEWARE (CSP + HSTS)
 * =========================================================
 */
app.use((req, res, next) => {
  const nonce = req.cspNonce || '';
  const nonceDirective = nonce ? getNonceDirective(nonce) : '';
  const cspConfig = getCSPConfig(nonceDirective);
  const hstsConfig = getHSTSConfig();

  helmet({
    contentSecurityPolicy: {
      directives: cspConfig,
    },
    hsts: hstsConfig,
    frameguard: { action: 'deny' },
    noSniff: true,
    referrerPolicy: { policy: 'strict-origin-when-cross-origin' },
  })(req, res, next);
});

/**
 * =========================================================
 * CORS MIDDLEWARE
 * =========================================================
 */
const corsOptions = getCORSConfig();
app.use(cors(corsOptions));
app.options('*', cors(corsOptions)); // Explicit preflight handling

/**
 * =========================================================
 * HTTPS ENFORCEMENT (Production Only)
 * =========================================================
 * Only redirects HTTP to HTTPS in production
 * Development allows HTTP for localhost
 * Note: enforceHttps middleware also sets HSTS header (production only)
 */
if (isProduction) {
  app.use(enforceHttps);
}

/**
 * =========================================================
 * HSTS SAFEGUARD (Development Check)
 * =========================================================
 * Runtime check to ensure HSTS header is NOT set in development
 * Throws error if HSTS is detected (prevents accidental misconfiguration)
 */
if (isDevelopment) {
  app.use((req, res, next) => {
    // Override res.setHeader to detect HSTS in development
    const originalSetHeader = res.setHeader.bind(res);
    res.setHeader = function(name, value) {
      if (typeof name === 'string' && name.toLowerCase() === 'strict-transport-security') {
        console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.error('ðŸš¨ HSTS DETECTED IN DEVELOPMENT!');
        console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.error('HSTS header attempted:', name, value);
        console.error('This will cause Chrome to block HTTP localhost requests!');
        console.error('Stack trace:', new Error().stack);
        console.error('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        // Don't actually set the header - silently ignore in development
        return;
      }
      return originalSetHeader(name, value);
    };
    next();
  });
}

/**
 * =========================================================
 * LOGGING
 * =========================================================
 */
app.use(morgan(isDevelopment ? 'dev' : 'combined'));

/**
 * =========================================================
 * RATE LIMITING
 * =========================================================
 */
app.use('/api', rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: isProduction ? 500 : 5000, // Stricter in production
}));

app.use('/api', slowDown({
  windowMs: 15 * 60 * 1000,
  delayAfter: 100,
  delayMs: hits => hits * 500,
}));

/**
 * =========================================================
 * BODY PARSING + COOKIES
 * =========================================================
 */
app.use(express.json({ limit: '20kb' }));
app.use(express.urlencoded({ extended: true, limit: '20kb' }));
app.use(cookieParser());

/**
 * =========================================================
 * CSRF PROTECTION
 * =========================================================
 * CSRF middleware handles dev/prod internally:
 * - Skips GET/HEAD/OPTIONS requests
 * - Skips public routes
 * - Only enforces for state-changing methods (POST/PUT/PATCH/DELETE)
 * - Cookie-based token validation
 */
app.get('/api/v1/csrf-token', getCsrfToken);
app.use('/api/v1', csrfProtection);

/**
 * =========================================================
 * DATA SANITIZATION
 * =========================================================
 */
app.use(mongoSanitize());
app.use(xss());
app.use(hpp());

/**
 * =========================================================
 * COMPRESSION
 * =========================================================
 */
app.use(compression());

/**
 * =========================================================
 * STATIC FILES
 * =========================================================
 */
app.use(express.static(path.join(__dirname, '../../public')));

/**
 * =========================================================
 * ROUTES
 * =========================================================
 */
app.use('/api/v1/product', require('./routes/shared/productRoutes'));
app.use('/api/v1/categories', require('./routes/shared/categoryRoutes'));
app.use('/api/v1/search', require('./routes/shared/searchRoutes'));
app.use('/api/v1/payment', require('./routes/shared/paymentRoutes'));
app.use('/api/v1/users', require('./routes/buyer/userRoutes'));

/**
 * =========================================================
 * HEALTH CHECK
 * =========================================================
 */
app.get('/health', (_, res) => res.json({ status: 'ok' }));

/**
 * =========================================================
 * 404 HANDLER
 * =========================================================
 */
app.all('*', (req, _, next) =>
  next(new AppError(`Can't find ${req.originalUrl}`, 404)),
);

/**
 * =========================================================
 * GLOBAL ERROR HANDLER
 * =========================================================
 */
app.use(globalErrorHandler);

module.exports = app;
